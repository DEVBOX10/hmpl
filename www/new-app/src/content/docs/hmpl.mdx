---
title: HMPL Template Language Specification
---

# Overview

The [HMPL](https://github.com/hmpl-language/hmpl) is a declarative template language designed for server-side UI rendering with client-side interactivity. The language combines:

- [JSON5](https://www.npmjs.com/package/json5)-based syntax for request configuration
- HTML templating capabilities
- Integrated security via [DOMPurify](https://www.npmjs.com/package/dompurify)
- Event-driven updates

# Template Syntax

HMPL templates consist of standard HTML markup interspersed with request configuration components, enclosed by special markers: `{{#request ...}}` or the short form `{{#r ...}}`.

```html
<div>
  <button data-action="increment" id="btn">Click!</button>
  <div>
    Clicks: {{#request src="/api/clicks" after="click:#btn"}} {{/request}}
  </div>
</div>
```

Key characteristics:

- Attributes must follow a JSON5-like syntax for values
- Always enclosed within `{{#request ...}}{{/request}}` or `{{#r ...}}{{/r}}`
- Blocks can appear anywhere within HTML markup
- **Nested request blocks are not allowed**
- Unclosed or malformed blocks will cause a parse error
- Supported value types: strings, numbers, booleans, arrays, objects

# Compilation

## compile

The `compile` method processes HMPL template strings into executable template functions (`HMPLTemplateFunction`).

| Parameter | Type               | Description                                       | Required |
| --------- | ------------------ | ------------------------------------------------- | -------- |
| template  | string             | HMPL template string containing HTML and requests | Yes      |
| options   | HMPLCompileOptions | Compilation configuration parameters              | No       |

```js
const templateFn = hmpl.compile(`{{#request src="/api/test"}}{{/request}}`, {
  memo: true,
  autoBody: { formData: true },
  allowedContentTypes: ["text/html"],
  disallowedTags: ["script"],
  sanitize: false
});
```

## Compilation Options

| Property            | Type                           | Default       | Description                                      |
| ------------------- | ------------------------------ | ------------- | ------------------------------------------------ |
| memo                | boolean                        | false         | Enables response caching for identical requests. |
| autoBody            | boolean \| HMPLAutoBodyOptions | false         | Configures automatic request body generation.    |
| allowedContentTypes | HMPLContentTypes               | ["text/html"] | Permitted response Content-Type headers.         |
| sanitize            | HMPLSanitize                   | false         | Enables HTML sanitization of server responses.   |
| disallowedTags      | HMPLDisallowedTags             | []            | HTML elements to remove from responses.          |

Note: Request-specific configurations override these defaults when provided.

## stringify

Serializes `HMPLRequestInfo` objects into request component strings suitable for template embedding.

```js
const info = hmpl.stringify({ src: "/api/test" });
const templateFn = hmpl.compile(`${info}`);
// {{#request src="/api/test"}}{{/request}}
```

# Template Function

The `HMPLTemplateFunction` instantiates template executions, managing server requests and DOM updates. Each invocation creates an independent `HMPLInstance`.

| Parameter | Type                                                                          | Description                                            |
| --------- | ----------------------------------------------------------------------------- | ------------------------------------------------------ |
| options   | HMPLIdentificationRequestInit[] \| HMPLRequestInit \| HMPLRequestInitFunction | Configuration for request initialization and execution |

```js
const elementObj = templateFn();
// Returns: { response: div, status: 200 }
```

# RequestInit

The `HMPLRequestInit` interface extends the standard [RequestInit](https://developer.mozilla.org/en-US/docs/Web/API/RequestInit) with HMPL-specific properties.

| Property       | Type                | Description                                               |
| -------------- | ------------------- | --------------------------------------------------------- |
| mode           | RequestMode         | The mode of the request (cors, no-cors, same-origin)      |
| cache          | RequestCache        | The cache mode for the request                            |
| redirect       | RequestRedirect     | How to handle redirects (follow, error, manual)           |
| referrerPolicy | ReferrerPolicy      | Policy for the referrer header                            |
| integrity      | string              | Subresource integrity value for the request               |
| referrer       | string              | The referrer URL for the request                          |
| get            | HMPLRequestGet      | Optional function to retrieve properties from the request |
| body           | BodyInit \| null    | The body of the request (can be a string, FormData, etc.) |
| signal         | AbortSignal \| null | An AbortSignal to abort the request if needed             |
| window         | any                 | Reference to the window object (if applicable)            |
| credentials    | RequestCredentials  | Credentials mode for the request                          |
| headers        | HMPLHeadersInit     | Custom headers for the request                            |
| timeout        | number              | Optional timeout duration for the request in ms           |

```js
const elementObj = templateFn({
  mode: "cors",
  cache: "no-cache",
  credentials: "same-origin",
  headers: {
    "Content-Type": "text/html"
  },
  redirect: "follow",
  get: (prop, value) => {},
  referrerPolicy: "no-referrer",
  body: JSON.stringify(data),
  signal: new AbortController().signal,
  integrity: "...",
  window: null,
  referrer: "about:client"
});
```

# Request Configuration

Request components define how and when the template makes server requests. These JSON5 objects appear within template markup and support the following properties:

| Property            | Type                           | Default       | Description                                        |
| ------------------- | ------------------------------ | ------------- | -------------------------------------------------- |
| src                 | string                         | — (required)  | The source URL of the request                      |
| method              | string                         | "GET"         | The HTTP method used for the request               |
| after               | string                         | —             | Event trigger specification                        |
| repeat              | boolean                        | true          | Whether the request repeats on subsequent triggers |
| interval            | number                         | —             | Optional interval for repeated requests (in ms)    |
| indicators          | HMPLIndicator[]                | []            | Status-specific UI indicators                      |
| autoBody            | boolean \| HMPLAutoBodyOptions | false         | Configures automatic body generation               |
| memo                | boolean                        | false         | Enables response caching                           |
| initId              | string \| number               | —             | Identifier for request initialization              |
| allowedContentTypes | HMPLContentTypes               | ["text/html"] | Permitted response Content-Types                   |
| disallowedTags      | HMPLDisallowedTags             | []            | HTML elements to remove from responses             |
| sanitize            | HMPLSanitize                   | false         | Enables HTML sanitization                          |

## src

The `src` property specifies the target URL for the request. This property is required for all request configurations.

| Example                       | Resolution                          |
| ----------------------------- | ----------------------------------- |
| `src="http://github.com/api"` | Absolute URL used as-is             |
| `src="/api/test"`             | Resolved relative to current origin |

## method

The `method` property defines the HTTP verb for the request. Supported methods include: `GET`, `POST`, `PUT`, `PATCH`, `DELETE`, `OPTIONS`, `TRACE`.

## after

The `after` property specifies event-based request triggering using the format `${eventType}:${selector}` (e.g., `click:#btn`).

| Event Type | Description            |
| ---------- | ---------------------- |
| click      | Mouse click events     |
| submit     | Form submission events |
| change     | Input change events    |

## repeat

The `repeat` property controls whether a request re-executes on subsequent trigger events:

- `true`: Request executes on every trigger (default)
- `false`: Request executes once, then removes listeners

## interval

The `interval` property specifies a time-based trigger for sending a request to the server at regular intervals (ms).

## indicators

The `indicators` property defines the HTML content that should be rendered in response to a particular request status. This property enables authors to provide user interface feedback corresponding to specific states of a request initiated by the HMPL module.

| Property | Type                 | Description                                     |
| -------- | -------------------- | ----------------------------------------------- |
| trigger  | HMPLIndicatorTrigger | Condition under which the content is displayed. |
| content  | string               | HTML markup to be rendered for the trigger.     |

Permissible values for `trigger`:

- HTTP status codes `400`–`599`
- `"pending"` (request in progress)
- `"rejected"` (fetch failed)
- `"error"` (any error: rejected or HTTP 4xx/5xx)

## autoBody

The `autoBody` property specifies automatic generation of the `body` property within a `HMPLRequestInit` object. Accepts a boolean or an object (`HMPLAutoBodyOptions`).

| Value  | Behavior                                                     |
| ------ | ------------------------------------------------------------ |
| true   | Enables automatic `FormData` generation using default rules. |
| false  | Disables automatic body generation (default).                |
| object | Enables configuration of specific generation parameters.     |

## memo

The `memo` property enables response caching for identical requests. Only active when `repeat` is true.

## initId

The `initId` property establishes an explicit association between a request and a predefined initialization object. Value: string or number.

## allowedContentTypes

The `allowedContentTypes` property defines the list of permissible `Content-Type` values for HTTP responses. Value: string[] or "\*".

## disallowedTags

The `disallowedTags` property specifies HTML elements to remove from responses. Supported: `"script"`, `"style"`, `"iframe"`.

## sanitize

The `sanitize` property enables DOMPurify-based HTML sanitization. When enabled, removes potentially malicious content.

# Nested Blocks

## indicator

The `{{#indicator}}` block is a template-level equivalent to an `HMPLIndicator` object within the `indicators` array. It must be placed directly within a `{{#request}}` block. Multiple indicator blocks can be used for different request states.

```html
{{#request src="/api/data"}} {{#indicator trigger="pending"}}
<p>Loading...</p>
{{/indicator}} {{#indicator trigger="rejected"}}
<p>An error occurred.</p>
{{/indicator}} {{/request}}
```

- The `trigger` attribute is required and supports the same values as the `indicators` property.
- If both the `indicators` property and `{{#indicator}}` blocks are present, the blocks take precedence.

# Type Definitions

## HMPLRequestInit

```ts
interface HMPLRequestInit {
  mode?: RequestMode;
  cache?: RequestCache;
  redirect?: RequestRedirect;
  referrerPolicy?: ReferrerPolicy;
  integrity?: string;
  referrer?: string;
  get?: HMPLRequestGet;
  body?: BodyInit | null;
  signal?: AbortSignal | null;
  window?: any;
  credentials?: RequestCredentials;
  headers?: HMPLHeadersInit;
  timeout?: number;
}
```

## HMPLInstance

```ts
interface HMPLInstance {
  response: undefined | Element | null;
  status?: HMPLRequestStatus;
  requests?: HMPLRequest[];
}
```

## HMPLInstanceContext

```ts
interface HMPLInstanceContext {
  request: HMPLRequestContext;
}

interface HMPLRequestContext {
  event?: Event;
  clearInterval?: () => void;
}
```

## HMPLRequest

```ts
interface HMPLRequest {
  response: undefined | Element | null | ChildNode[];
  status: number;
  id?: string;
}
```

## HMPLRequestGet

```ts
type HMPLRequestGet = (
  prop: string,
  value: any,
  context: HMPLInstanceContext,
  request?: HMPLRequest
) => void;
```

## HMPLRequestInfo

```ts
interface HMPLRequestInfo {
  src: string;
  method?: string;
  initId?: string | number;
  after?: string;
  repeat?: boolean;
  memo?: boolean;
  interval?: number;
  allowedContentTypes?: HMPLContentTypes;
  indicators?: HMPLIndicator[];
  sanitize?: HMPLSanitize;
  disallowedTags?: HMPLDisallowedTags;
  autoBody?: boolean | HMPLAutoBodyOptions;
}
```

## HMPLCompile

```ts
type HMPLCompile = (
  template: string,
  options?: HMPLCompileOptions
) => HMPLTemplateFunction;
```

## HMPLCompileOptions

```ts
interface HMPLCompileOptions {
  memo?: boolean;
  autoBody?: boolean | HMPLAutoBodyOptions;
  allowedContentTypes?: HMPLContentTypes;
  sanitize?: HMPLSanitize;
  disallowedTags?: HMPLDisallowedTags;
}
```

## HMPLTemplateFunction

```ts
type HMPLTemplateFunction = (
  options?:
    | HMPLIdentificationRequestInit[]
    | HMPLRequestInit
    | HMPLRequestInitFunction
) => HMPLInstance;
```

## HMPLClearInterval

```ts
type HMPLClearInterval = () => void;
```

## HMPLAutoBodyOptions

```ts
interface HMPLAutoBodyOptions {
  formData?: boolean;
}
```

## HMPLInitalStatus

```ts
type HMPLInitalStatus =
  | "pending"
  | "rejected"
  | 100
  | 101
  | 102
  | 103
  | 300
  | 301
  | 302
  | 303
  | 304
  | 305
  | 306
  | 307
  | 308
  | 400
  | 401
  | 402
  | 403
  | 404
  | 405
  | 406
  | 407
  | 408
  | 409
  | 410
  | 411
  | 412
  | 413
  | 414
  | 415
  | 416
  | 417
  | 418
  | 421
  | 422
  | 423
  | 424
  | 425
  | 426
  | 428
  | 429
  | 431
  | 451
  | 500
  | 501
  | 502
  | 503
  | 504
  | 505
  | 506
  | 507
  | 508
  | 510
  | 511;
```

## HMPLIndicatorTrigger

```ts
type HMPLIndicatorTrigger = HMPLInitalStatus | "error";
```

## HMPLRequestStatus

```ts
type HMPLRequestStatus =
  | HMPLInitalStatus
  | 200
  | 201
  | 202
  | 203
  | 204
  | 205
  | 206
  | 207
  | 208
  | 226;
```

## HMPLContentTypes

```ts
type HMPLContentTypes = string[] | "*";
```

## HMPLDisallowedTag

```ts
type HMPLDisallowedTag = "script" | "style" | "iframe";
```

## HMPLDisallowedTags

```ts
type HMPLDisallowedTags = HMPLDisallowedTag[];
```

## HMPLSanitize

```ts
type HMPLSanitize = boolean;
```

## HMPLIndicator

```ts
interface HMPLIndicator {
  trigger: HMPLIndicatorTrigger;
  content: string;
}
```

## HMPLHeadersInit

```ts
interface HMPLHeadersInit {
  [key: string]: string;
}
```

## HMPLIdentificationRequestInit

```ts
interface HMPLIdentificationRequestInit {
  value: HMPLRequestInit | HMPLRequestInitFunction;
  id: string | number;
}
```

## HMPLRequestInitFunction

```ts
type HMPLRequestInitFunction = (
  context: HMPLInstanceContext
) => HMPLRequestInit;
```
